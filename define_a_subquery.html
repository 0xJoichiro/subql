<!DOCTYPE html>
<html lang="English">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Define the SubQuery | SubQuery</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="SubQuery is a open-source tool to provide a complete process and query data solution to every substrate project and will become core infrastructure for the Polkadot ecosystem.">
    
    <link rel="preload" href="/assets/css/0.styles.bb684b6e.css" as="style"><link rel="preload" href="/assets/js/app.6d5843cd.js" as="script"><link rel="preload" href="/assets/js/3.d869eaf8.js" as="script"><link rel="preload" href="/assets/js/9.b30423e1.js" as="script"><link rel="prefetch" href="/assets/js/10.e06c5c47.js"><link rel="prefetch" href="/assets/js/11.da90f40a.js"><link rel="prefetch" href="/assets/js/12.60a4c05c.js"><link rel="prefetch" href="/assets/js/13.4f9a59bd.js"><link rel="prefetch" href="/assets/js/14.fd1822c3.js"><link rel="prefetch" href="/assets/js/15.11f0fefc.js"><link rel="prefetch" href="/assets/js/16.0a06e0a2.js"><link rel="prefetch" href="/assets/js/17.89cffd54.js"><link rel="prefetch" href="/assets/js/18.e534caa2.js"><link rel="prefetch" href="/assets/js/19.61e855b5.js"><link rel="prefetch" href="/assets/js/20.79a3e342.js"><link rel="prefetch" href="/assets/js/21.eb4b0c28.js"><link rel="prefetch" href="/assets/js/4.7ce66604.js"><link rel="prefetch" href="/assets/js/5.8feca752.js"><link rel="prefetch" href="/assets/js/6.7f0ce380.js"><link rel="prefetch" href="/assets/js/7.03a52a57.js"><link rel="prefetch" href="/assets/js/8.fba2b955.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.4b42ec77.js">
    <link rel="stylesheet" href="/assets/css/0.styles.bb684b6e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">SubQuery</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="https://onfinality.io/" target="_self" class="nav-link external">
  OnFinality
  <!----></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="https://onfinality.io/" target="_self" class="nav-link external">
  OnFinality
  <!----></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/quickstart.html" class="sidebar-link">Quick start</a></li><li><a href="/directory_structure.html" class="sidebar-link">Directory Structure</a></li><li><a href="/define_a_subquery.html" aria-current="page" class="active sidebar-link">Define the SubQuery</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/define_a_subquery.html#the-manifest" class="sidebar-link">The Manifest</a></li><li class="sidebar-sub-header"><a href="/define_a_subquery.html#the-graphql-schema" class="sidebar-link">The GraphQL Schema</a></li><li class="sidebar-sub-header"><a href="/define_a_subquery.html#mapping-function" class="sidebar-link">Mapping function</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/define_a_subquery.html#blockhandler" class="sidebar-link">BlockHandler</a></li><li class="sidebar-sub-header"><a href="/define_a_subquery.html#eventhandler" class="sidebar-link">EventHandler</a></li><li class="sidebar-sub-header"><a href="/define_a_subquery.html#callhandler" class="sidebar-link">CallHandler</a></li><li class="sidebar-sub-header"><a href="/define_a_subquery.html#apply-filter" class="sidebar-link">Apply filter</a></li></ul></li><li class="sidebar-sub-header"><a href="/define_a_subquery.html#code-generation" class="sidebar-link">Code Generation</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="define-the-subquery"><a href="#define-the-subquery" class="header-anchor">#</a> Define the SubQuery</h1> <h2 id="the-manifest"><a href="#the-manifest" class="header-anchor">#</a> The Manifest</h2> <p>The <code>project.yaml</code> is an entry point of your project. It defined the endpoint of the blockchain to be indexed.
<code>dataSources.kind</code> defines the type of datasources. In <code>mapping.handlers</code> will list all the <a href="#mapping-function">mapping functions</a> and their corresponding handler types,
also <a href="#apply-filter">filters</a>.</p> <h2 id="the-graphql-schema"><a href="#the-graphql-schema" class="header-anchor">#</a> The GraphQL Schema</h2> <p>It is must define the GraphQL schemas inside of <code>schema.graphql</code> file. To know how to write in  &quot;GraphQL schema language&quot;,
we recommend to check out on <a href="https://graphql.org/learn/schema/#type-language" target="_blank" rel="noopener noreferrer">Schemas and Types<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>We currently supporting flowing types:</p> <ul><li><code>ID</code></li> <li><code>Int</code></li> <li><code>String</code></li> <li><code>BigInt</code></li> <li><code>Date</code></li></ul> <h2 id="mapping-function"><a href="#mapping-function" class="header-anchor">#</a> Mapping function</h2> <p>The mappings function defined how to transform the indexed data into the entities have defined in the schema above. Mappings are written
in a subset of TypeScript called AssemblyScript which can be compiled to WASM (WebAssembly).</p> <ul><li><p>We also provided a few examples of a mapping function in <code>src/mappings/mappingHandlers.ts</code>. For each handler that is defined in <code>project.yaml</code>
under mapping.handlers, create an exported function of the same name.</p></li> <li><p>Also, under the <code>src/index.ts</code>, you have to export the functions of handlers as defined in above.</p></li></ul> <p>According to the different input parameters, they can be classified into three types, namely <a href="#blockhandler">Blockhandler</a>, <a href="#eventhandler">EventHandler</a> and <a href="#callhandler">CallHandler</a>.</p> <h3 id="blockhandler"><a href="#blockhandler" class="header-anchor">#</a> BlockHandler</h3> <p>Each time a new block is attached to the Substrate chain, it is likely we want to capture some useful information, e.g. block number.
To achieve this this, a defined BlockHandler will be called once for every block.</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleBlock</span><span class="token punctuation">(</span>block<span class="token operator">:</span> SignedBlock<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//Create a new starterEntity with ID using block hash</span>
    <span class="token keyword">let</span> record <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">starterEntity</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>block<span class="token punctuation">.</span>header<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    record<span class="token punctuation">.</span>field1 <span class="token operator">=</span> block<span class="token punctuation">.</span>block<span class="token punctuation">.</span>header<span class="token punctuation">.</span><span class="token builtin">number</span><span class="token punctuation">.</span><span class="token function">toNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> record<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="eventhandler"><a href="#eventhandler" class="header-anchor">#</a> EventHandler</h3> <p>The events that are part of the default Substrate runtime and a block may contain multiple events.
To process these events, the event handler will receive an substrate event as an argument with the typed inputs
to and outputs from the event. Any type of events will trigger the mapping, allowing activity with the data source to be captured.</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleEvent</span><span class="token punctuation">(</span>event<span class="token operator">:</span> SubstrateEvent<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>event<span class="token operator">:</span> <span class="token punctuation">{</span>data<span class="token operator">:</span> <span class="token punctuation">[</span>account<span class="token punctuation">,</span> balance<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">=</span> event<span class="token punctuation">;</span>
    <span class="token comment">//Retrieve the record by its ID</span>
    <span class="token keyword">const</span> record <span class="token operator">=</span> <span class="token keyword">await</span> starterEntity<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>extrinsic<span class="token punctuation">.</span>block<span class="token punctuation">.</span>block<span class="token punctuation">.</span>header<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    record<span class="token punctuation">.</span>field2 <span class="token operator">=</span> account<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    record<span class="token punctuation">.</span>field3 <span class="token operator">=</span> <span class="token punctuation">(</span>balance <span class="token keyword">as</span> Balance<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBigInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> record<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="callhandler"><a href="#callhandler" class="header-anchor">#</a> CallHandler</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleCall</span><span class="token punctuation">(</span>extrinsic<span class="token operator">:</span> SubstrateExtrinsic<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> record <span class="token operator">=</span> <span class="token keyword">await</span> starterEntity<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>extrinsic<span class="token punctuation">.</span>block<span class="token punctuation">.</span>block<span class="token punctuation">.</span>header<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    record<span class="token punctuation">.</span>field4 <span class="token operator">=</span> extrinsic<span class="token punctuation">.</span>block<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
    <span class="token keyword">await</span> record<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="apply-filter"><a href="#apply-filter" class="header-anchor">#</a> Apply filter</h3> <p>In the <code>project.yml</code>, you may have noticed we are supporting filter feature for <code>EventHandler</code> and <code>Call Handlers.</code>
Applying the filter means any extrinsic/event that does not match the required module and section will not be processed further. Doing this will significantly reduce the workload from the mapping function side.</p> <p>Also, using the filter is an option, but here is an example in your manifest:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">filter</span><span class="token punctuation">:</span> 
   <span class="token key atrule">module</span><span class="token punctuation">:</span> balances
   <span class="token key atrule">method</span><span class="token punctuation">:</span> Deposit
</code></pre></div><p>To find out module and method are supported, check out <a href="https://polkadot.js.org/docs/substrate/extrinsics" target="_blank" rel="noopener noreferrer">Extrinsics<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for CallHandler,
and <a href="https://polkadot.js.org/docs/substrate/events" target="_blank" rel="noopener noreferrer">Events<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for EventHandler.</p> <h2 id="code-generation"><a href="#code-generation" class="header-anchor">#</a> Code Generation</h2> <div class="language- extra-class"><pre class="language-text"><code>$yarn codegen
</code></pre></div><ul><li>This will create a new directory <code>src/types</code> which contains all generated entities in AssemblyScript.</li> <li>Generated entity class for each type you have defined previously in <code>schema.graphql</code>. These classes provide type-safe
entity loading, read and write access to entity fields.</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/directory_structure.html" class="prev">
        Directory Structure
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.6d5843cd.js" defer></script><script src="/assets/js/3.d869eaf8.js" defer></script><script src="/assets/js/9.b30423e1.js" defer></script>
  </body>
</html>

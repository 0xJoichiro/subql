<!DOCTYPE html>
<html lang="English">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Define the SubQuery | SubQuery Guide</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="SubQuery is a open-source tool to provide a complete process and query data solution to every substrate project and will become core infrastructure for the Polkadot ecosystem.">
    
    <link rel="preload" href="/assets/css/0.styles.164b3159.css" as="style"><link rel="preload" href="/assets/js/app.eb975856.js" as="script"><link rel="preload" href="/assets/js/3.31cd00bf.js" as="script"><link rel="preload" href="/assets/js/9.de33af47.js" as="script"><link rel="prefetch" href="/assets/js/10.b4d9cbf4.js"><link rel="prefetch" href="/assets/js/11.db4ece6a.js"><link rel="prefetch" href="/assets/js/12.945c592a.js"><link rel="prefetch" href="/assets/js/13.e914dc48.js"><link rel="prefetch" href="/assets/js/14.6e9f0979.js"><link rel="prefetch" href="/assets/js/15.62eb5134.js"><link rel="prefetch" href="/assets/js/16.0568aa89.js"><link rel="prefetch" href="/assets/js/17.d64dd3f9.js"><link rel="prefetch" href="/assets/js/18.9b159087.js"><link rel="prefetch" href="/assets/js/19.1da6ee6e.js"><link rel="prefetch" href="/assets/js/20.75b74bd9.js"><link rel="prefetch" href="/assets/js/21.9373c654.js"><link rel="prefetch" href="/assets/js/4.7ff821b6.js"><link rel="prefetch" href="/assets/js/5.4cde51ba.js"><link rel="prefetch" href="/assets/js/6.08a179cc.js"><link rel="prefetch" href="/assets/js/7.9143c72c.js"><link rel="prefetch" href="/assets/js/8.19578287.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.c6292dad.js">
    <link rel="stylesheet" href="/assets/css/0.styles.164b3159.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/logo.png" alt="SubQuery Guide" class="logo"> <span class="site-name can-hide">SubQuery Guide</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://www.subquery.network/" target="_self" class="nav-link external">
  SubQuery
  <!----></a></div><div class="nav-item"><a href="/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="https://onfinality.io/" target="_self" class="nav-link external">
  OnFinality
  <!----></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://www.subquery.network/" target="_self" class="nav-link external">
  SubQuery
  <!----></a></div><div class="nav-item"><a href="/" class="nav-link">
  Guide
</a></div><div class="nav-item"><a href="https://onfinality.io/" target="_self" class="nav-link external">
  OnFinality
  <!----></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/quickstart.html" class="sidebar-link">Quick start</a></li><li><a href="/directory_structure.html" class="sidebar-link">Directory Structure</a></li><li><a href="/define_a_subquery.html" aria-current="page" class="active sidebar-link">Define the SubQuery</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/define_a_subquery.html#the-manifest" class="sidebar-link">The Manifest</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/define_a_subquery.html#apply-filter" class="sidebar-link">Apply filter</a></li></ul></li><li class="sidebar-sub-header"><a href="/define_a_subquery.html#the-graphql-schema" class="sidebar-link">The GraphQL Schema</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/define_a_subquery.html#defining-entities" class="sidebar-link">Defining Entities</a></li><li class="sidebar-sub-header"><a href="/define_a_subquery.html#optional-and-required-fields" class="sidebar-link">Optional and required fields</a></li><li class="sidebar-sub-header"><a href="/define_a_subquery.html#supported-scalars-and-types" class="sidebar-link">Supported scalars and types</a></li><li class="sidebar-sub-header"><a href="/define_a_subquery.html#entity-relationships" class="sidebar-link">Entity Relationships</a></li></ul></li><li class="sidebar-sub-header"><a href="/define_a_subquery.html#mapping-function" class="sidebar-link">Mapping function</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/define_a_subquery.html#blockhandler" class="sidebar-link">BlockHandler</a></li><li class="sidebar-sub-header"><a href="/define_a_subquery.html#eventhandler" class="sidebar-link">EventHandler</a></li><li class="sidebar-sub-header"><a href="/define_a_subquery.html#callhandler" class="sidebar-link">CallHandler</a></li><li class="sidebar-sub-header"><a href="/define_a_subquery.html#query-states" class="sidebar-link">Query States</a></li><li class="sidebar-sub-header"><a href="/define_a_subquery.html#examples" class="sidebar-link">Examples</a></li></ul></li><li class="sidebar-sub-header"><a href="/define_a_subquery.html#code-generation" class="sidebar-link">Code Generation</a></li><li class="sidebar-sub-header"><a href="/define_a_subquery.html#build" class="sidebar-link">Build</a></li><li class="sidebar-sub-header"><a href="/define_a_subquery.html#pack" class="sidebar-link">Pack</a></li></ul></li><li><a href="/indexing_query.html" class="sidebar-link">Indexing and Query</a></li><li><a href="/sandbox.html" class="sidebar-link">The sandbox</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="define-the-subquery"><a href="#define-the-subquery" class="header-anchor">#</a> Define the SubQuery</h1> <h2 id="the-manifest"><a href="#the-manifest" class="header-anchor">#</a> The Manifest</h2> <p>The Manifest <code>project.yaml</code> can be seen as an entry point of your project, it provides the following specifications in order to index and query a SubQuery.</p> <p>The Manifest can be in either YAML or JSON format.</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">specVersion</span><span class="token punctuation">:</span> <span class="token string">&quot;0.0.1&quot;</span>
<span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">&quot;This subquery indexes kitty's birth info&quot;</span>
<span class="token key atrule">repository</span><span class="token punctuation">:</span> <span class="token string">&quot;https://github.com/onfinality-io/subql-examples&quot;</span>
<span class="token key atrule">schema</span><span class="token punctuation">:</span> <span class="token string">&quot;./schema.graphql&quot;</span>
<span class="token key atrule">network</span><span class="token punctuation">:</span>
  <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> <span class="token string">&quot;ws://host.kittychain.io/public-ws&quot;</span>
  <span class="token key atrule">types</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token key atrule">&quot;KittyIndex&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;u32&quot;</span><span class="token punctuation">,</span>
    <span class="token key atrule">&quot;Kitty&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;[u8; 16]&quot;</span>
  <span class="token punctuation">}</span>
<span class="token comment"># typesChain: { chain: { Type5: 'example' } }</span>
<span class="token comment"># typesSpec: { spec: { Type6: 'example' } }</span>
<span class="token key atrule">dataSources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> runtime
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> substrate/Runtime
    <span class="token key atrule">startBlock</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">mapping</span><span class="token punctuation">:</span>
      <span class="token key atrule">handlers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">handler</span><span class="token punctuation">:</span> handleKittyBred
          <span class="token key atrule">kind</span><span class="token punctuation">:</span> substrate/CallHandler
          <span class="token key atrule">filter</span><span class="token punctuation">:</span>
            <span class="token key atrule">module</span><span class="token punctuation">:</span> kitties
            <span class="token key atrule">method</span><span class="token punctuation">:</span> breed
            <span class="token key atrule">success</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><ul><li><p><code>specVersion</code> indicating which version of this API is being used.</p></li> <li><p><code>schema</code> pointing to the GraphQL schema of this SubQuery.</p></li> <li><p>The <code>network.endpoint</code> defined the endpoint of the blockchain to be indexed.</p></li> <li><p>We support the additional types used by substrate runtime modules.
The <code>network.types</code> declare the specific types supported by this blockchain, also <code>typesAlias</code>,<code>typesBundle</code>,<code>typesChain</code> and <code>typesSpec</code> are supported.</p></li> <li><p>The dataSources defines the data will be extracted and the logic of data transformation to be applied.</p> <ul><li>For <code>dataSources.kind</code>, we are only supporting <code>substrate/Runtime</code> at the moment.</li> <li>The <code>startBlock</code> specify the block height to start indexing from.</li> <li>In <code>mapping.handlers</code> will list all the <a href="#mapping-function">mapping functions</a> and their corresponding handler types,
also <a href="#apply-filter">filters</a>.</li></ul></li></ul> <h3 id="apply-filter"><a href="#apply-filter" class="header-anchor">#</a> Apply filter</h3> <p>In above, you may have noticed we are supporting the optional filter feature.
The applied filtering decide which block/event/extrinsic will trigger the mapping.
Incoming data does not meet the requirement will not be processed further; this implementation will significantly reduce the mapping function side's workload.</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment">#Example filter from callHandler</span>
<span class="token key atrule">filter</span><span class="token punctuation">:</span> 
   <span class="token key atrule">module</span><span class="token punctuation">:</span> balances
   <span class="token key atrule">method</span><span class="token punctuation">:</span> Deposit
   <span class="token key atrule">success</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><p>Following table explain filters supported by different handlers.</p> <table><thead><tr><th>Handler</th> <th>Supported filter</th></tr></thead> <tbody><tr><td><a href="#blockhandler">BlockHandler</a></td> <td><code>specVersion</code></td></tr> <tr><td><a href="#eventhandler">EventHandler</a></td> <td><code>module</code>,<code>method</code></td></tr> <tr><td><a href="#callhandler">CallHandler</a></td> <td><code>module</code>,<code>method</code> ,<code>success</code></td></tr></tbody></table> <ul><li><p>Module and method filter are supported to any substrate based chain.</p></li> <li><p>The <code>success</code> filter takes a boolean value, and can use to filtering the extrinsic by its success status.</p></li> <li><p>The <code>specVersion</code> filter specifies the spec version range for substrate block.
Following example describe how to set version ranges.</p></li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">filter</span><span class="token punctuation">:</span>
  <span class="token key atrule">specVersion</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">]</span>   <span class="token comment">#Index block with specVersion in between 23 and 24.</span>
<span class="token comment"># specVersion: [100]      #Index block with specVersion greater than or equal 100.</span>
<span class="token comment"># specVersion: [null, 23] #Index block with specVersion less than or equal 23.</span>
</code></pre></div><h2 id="the-graphql-schema"><a href="#the-graphql-schema" class="header-anchor">#</a> The GraphQL Schema</h2> <h3 id="defining-entities"><a href="#defining-entities" class="header-anchor">#</a> Defining Entities</h3> <p>It is must define the GraphQL schemas inside of <code>schema.graphql</code> file. To know how to write in  &quot;GraphQL schema language&quot;,
we recommend checking out on <a href="https://graphql.org/learn/schema/#type-language" target="_blank" rel="noopener noreferrer">Schemas and Types<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h3 id="optional-and-required-fields"><a href="#optional-and-required-fields" class="header-anchor">#</a> Optional and required fields</h3> <p>Each entity must define its required field <code>id</code> with the type of <code>ID!</code>, it used as the primary key and unique among all entities of the same type.</p> <p><strong>Required filed</strong> in the entity are indicated by the <code>!</code>.</p> <p>Please see the example below:</p> <div class="language-graphql extra-class"><pre class="language-graphql"><code><span class="token keyword">type</span> <span class="token class-name">Example</span> <span class="token directive function">@entity</span> <span class="token punctuation">{</span>
  <span class="token attr-name">id</span><span class="token punctuation">:</span> ID<span class="token operator">!</span> <span class="token comment">#id Entity is always required</span>
  <span class="token attr-name">name</span><span class="token punctuation">:</span> String<span class="token operator">!</span> <span class="token comment"># This is a required field</span>
  <span class="token attr-name">address</span><span class="token punctuation">:</span> String <span class="token comment">#This is an optional field</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="supported-scalars-and-types"><a href="#supported-scalars-and-types" class="header-anchor">#</a> Supported scalars and types</h3> <p>We currently supporting flowing scalars:</p> <ul><li><code>ID</code></li> <li><code>Int</code></li> <li><code>String</code></li> <li><code>BigInt</code></li> <li><code>Date</code></li> <li><code>Boolean</code></li></ul> <p>For nested relationship entities, you might use the defined entity's name as one of the fields. Please see in <a href="#entity-relationships">Entity Relationships</a>.</p> <h3 id="entity-relationships"><a href="#entity-relationships" class="header-anchor">#</a> Entity Relationships</h3> <p>An entity often has nested relationships with other entities. Set the field value to another entity name will define a unidirectional relationship between these two entities by default.</p> <p>From the entity's relationship perspectives, the entity can <code>belongsTo</code>,<code>hasOne</code>or<code>hasMany</code> with other entities. In following examples covers these scenarios.</p> <h4 id="one-to-one-relationships"><a href="#one-to-one-relationships" class="header-anchor">#</a> One-to-One relationships</h4> <p>Define a Passport entity type with a required one-to-one relationship with a Person entity type:</p> <div class="language-graphql extra-class"><pre class="language-graphql"><code><span class="token keyword">type</span> <span class="token class-name">Person</span> <span class="token directive function">@entity</span> <span class="token punctuation">{</span>
  <span class="token attr-name">id</span><span class="token punctuation">:</span> ID<span class="token operator">!</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token class-name">Passport</span> <span class="token directive function">@entity</span> <span class="token punctuation">{</span>
  <span class="token attr-name">id</span><span class="token punctuation">:</span> ID<span class="token operator">!</span>
  <span class="token attr-name">owner</span><span class="token punctuation">:</span> Person<span class="token operator">!</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="one-to-many-relationships"><a href="#one-to-many-relationships" class="header-anchor">#</a> One-to-Many relationships</h4> <p>Define a Contact entity type with an optional one-to-many relationship with a Person entity type.
And remember, use bracket to indicate a field type is multiple entities.</p> <div class="language-graphql extra-class"><pre class="language-graphql"><code><span class="token keyword">type</span> <span class="token class-name">Person</span> <span class="token directive function">@entity</span> <span class="token punctuation">{</span>
  <span class="token attr-name">id</span><span class="token punctuation">:</span> ID<span class="token operator">!</span>
  <span class="token attr-name">contacts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>Contact<span class="token punctuation">]</span> 
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token class-name">Contact</span> <span class="token directive function">@entity</span> <span class="token punctuation">{</span>
  <span class="token attr-name">id</span><span class="token punctuation">:</span> ID<span class="token operator">!</span>
  <span class="token attr-name">phone</span><span class="token punctuation">:</span> String<span class="token operator">!</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="many-to-many-relationships"><a href="#many-to-many-relationships" class="header-anchor">#</a> Many-to-Many relationships</h4> <p>A many-to-Many relationship can be achieved by implementing a middle entity to connect the other two entities.</p> <p>Also, it is possible to create a connection of the same entity in multiple fields of the middle entity.
For example, an account can have multiple transfers, and a transfer is also belongs to the account it transferred from and to.
This will establish a bidirectional relationship between two Accounts (from and to) through Transfer table.</p> <div class="language-graphql extra-class"><pre class="language-graphql"><code><span class="token keyword">type</span> <span class="token class-name">Account</span> <span class="token directive function">@entity</span> <span class="token punctuation">{</span>
  <span class="token attr-name">id</span><span class="token punctuation">:</span> ID<span class="token operator">!</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token class-name">Transfer</span> <span class="token directive function">@entity</span> <span class="token punctuation">{</span>
  <span class="token attr-name">id</span><span class="token punctuation">:</span> ID<span class="token operator">!</span>
  <span class="token attr-name">amount</span><span class="token punctuation">:</span> BigInt
  <span class="token attr-name">from</span><span class="token punctuation">:</span> Account<span class="token operator">!</span>
  <span class="token attr-name">to</span><span class="token punctuation">:</span> Account<span class="token operator">!</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="reverse-lookups"><a href="#reverse-lookups" class="header-anchor">#</a> Reverse Lookups</h4> <p>To enable reverse lookups on an entity, attach <code>@derivedFrom</code> to the field and point to its reverse lookup field of another entity.
This crate a virtual field on the entity that will be queried.</p> <p>The Transfer from an account accessible from the Account by deriving a transfers field:</p> <div class="language-graphql extra-class"><pre class="language-graphql"><code><span class="token keyword">type</span> <span class="token class-name">Account</span> <span class="token directive function">@entity</span> <span class="token punctuation">{</span>
  <span class="token attr-name">id</span><span class="token punctuation">:</span> ID<span class="token operator">!</span>
  <span class="token attr-name">transfers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>Transfer<span class="token punctuation">]</span> <span class="token directive function">@derivedFrom</span><span class="token punctuation">(</span><span class="token attr-name">field</span><span class="token punctuation">:</span> <span class="token string">&quot;from&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token class-name">Transfer</span> <span class="token directive function">@entity</span> <span class="token punctuation">{</span>
  <span class="token attr-name">id</span><span class="token punctuation">:</span> ID<span class="token operator">!</span>
  <span class="token attr-name">amount</span><span class="token punctuation">:</span> BigInt
  <span class="token attr-name">from</span><span class="token punctuation">:</span> Account<span class="token operator">!</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="mapping-function"><a href="#mapping-function" class="header-anchor">#</a> Mapping function</h2> <p>The mappings function defined how to transform the indexed data into the entities have defined in the schema above. Mappings are written
in a subset of TypeScript called AssemblyScript which can be compiled to WASM (WebAssembly).</p> <ul><li><p>In the <a href="/define_a_subquery.html#examples">examples</a> and its <code>project.yaml</code> under mapping.handlers, create an exported function of the same name.</p></li> <li><p>Also, under the <code>src/index.ts</code>, you have to export the functions of handlers as defined in above.</p></li></ul> <p>According to the different input parameters, they can be classified into three types, namely <a href="#blockhandler">Blockhandler</a>, <a href="#eventhandler">EventHandler</a> and <a href="#callhandler">CallHandler</a>.</p> <h3 id="blockhandler"><a href="#blockhandler" class="header-anchor">#</a> BlockHandler</h3> <p>Each time a new block is attached to the Substrate chain, it is likely we want to capture some useful information, e.g. block number.
To achieve this this, a defined BlockHandler will be called once for every block.</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>SubstrateBlock<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@subql/types&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleBlock</span><span class="token punctuation">(</span>block<span class="token operator">:</span> SubstrateBlock<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//Create a new starterEntity with ID using block hash</span>
    <span class="token keyword">let</span> record <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">starterEntity</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>block<span class="token punctuation">.</span>header<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    record<span class="token punctuation">.</span>field1 <span class="token operator">=</span> block<span class="token punctuation">.</span>block<span class="token punctuation">.</span>header<span class="token punctuation">.</span><span class="token builtin">number</span><span class="token punctuation">.</span><span class="token function">toNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> record<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="substrateblock"><a href="#substrateblock" class="header-anchor">#</a> SubstrateBlock</h4> <p>A <a href="https://github.com/OnFinality-io/subql/blob/a5ab06526dcffe5912206973583669c7f5b9fdc9/packages/types/src/interfaces.ts#L16" target="_blank" rel="noopener noreferrer">SubstrateBlock<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is an extend interface type of <a href="https://polkadot.js.org/docs/api/cookbook/blocks/" target="_blank" rel="noopener noreferrer">signedBlock<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>,
but also record the <code>specVersion</code> and <code>timestamp</code> from a block.</p> <h3 id="eventhandler"><a href="#eventhandler" class="header-anchor">#</a> EventHandler</h3> <p>The events that are part of the default Substrate runtime and a block may contain multiple events.
During the processing, the event handler will receive a substrate event as an argument with the event's typed inputs and outputs. Any type of events will trigger the mapping, allowing activity with the data source to be captured.</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>SubstrateEvent<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@subql/types&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleEvent</span><span class="token punctuation">(</span>event<span class="token operator">:</span> SubstrateEvent<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>event<span class="token operator">:</span> <span class="token punctuation">{</span>data<span class="token operator">:</span> <span class="token punctuation">[</span>account<span class="token punctuation">,</span> balance<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">=</span> event<span class="token punctuation">;</span>
    <span class="token comment">//Retrieve the record by its ID</span>
    <span class="token keyword">const</span> record <span class="token operator">=</span> <span class="token keyword">await</span> starterEntity<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>extrinsic<span class="token punctuation">.</span>block<span class="token punctuation">.</span>block<span class="token punctuation">.</span>header<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    record<span class="token punctuation">.</span>field2 <span class="token operator">=</span> account<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    record<span class="token punctuation">.</span>field3 <span class="token operator">=</span> <span class="token punctuation">(</span>balance <span class="token keyword">as</span> Balance<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBigInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> record<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="substrateevent"><a href="#substrateevent" class="header-anchor">#</a> SubstrateEvent</h4> <p>A <a href="https://github.com/OnFinality-io/subql/blob/a5ab06526dcffe5912206973583669c7f5b9fdc9/packages/types/src/interfaces.ts#L30" target="_blank" rel="noopener noreferrer">SubstrateEvent<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is an extend interface type of the <a href="https://github.com/polkadot-js/api/blob/f0ce53f5a5e1e5a77cc01bf7f9ddb7fcf8546d11/packages/types/src/interfaces/system/types.ts#L149" target="_blank" rel="noopener noreferrer">EventRecord<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.
Besides the event data, it is now also attached with an id, the block to which this event belongs, and the extrinsic inside of this block.</p> <h3 id="callhandler"><a href="#callhandler" class="header-anchor">#</a> CallHandler</h3> <p>The CallHandler is an exported function in the mapping script that should handle the specified substrate extrinsic.</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleCall</span><span class="token punctuation">(</span>extrinsic<span class="token operator">:</span> SubstrateExtrinsic<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> record <span class="token operator">=</span> <span class="token keyword">await</span> starterEntity<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>extrinsic<span class="token punctuation">.</span>block<span class="token punctuation">.</span>block<span class="token punctuation">.</span>header<span class="token punctuation">.</span>hash<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    record<span class="token punctuation">.</span>field4 <span class="token operator">=</span> extrinsic<span class="token punctuation">.</span>block<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
    <span class="token keyword">await</span> record<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="substrateextrinsic"><a href="#substrateextrinsic" class="header-anchor">#</a> SubstrateExtrinsic</h4> <p>The <a href="https://github.com/OnFinality-io/subql/blob/a5ab06526dcffe5912206973583669c7f5b9fdc9/packages/types/src/interfaces.ts#L21" target="_blank" rel="noopener noreferrer">SubstrateExtrinsic<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> assigned with an id, it provide an extrinsic property which extends <a href="https://github.com/polkadot-js/api/blob/a9c9fb5769dec7ada8612d6068cf69de04aa15ed/packages/types/src/extrinsic/Extrinsic.ts#L170" target="_blank" rel="noopener noreferrer">GenericExtrinsic<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, the block to which this extrinsic belongs, and the events among this block.
Last, it records the success status of this extrinsic.</p> <h3 id="query-states"><a href="#query-states" class="header-anchor">#</a> Query States</h3> <p>We wish to cover all data sources for the user in the mapping handler, other than the three configured interface types above. Therefore, we have exposed some of the @polkadot/api interfaces to increase the scalability.
These are the interface we supporting now:</p> <ul><li><p><a href="https://polkadot.js.org/docs/api/start/api.query" target="_blank" rel="noopener noreferrer">api.query.module.method()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> will query the <strong>current</strong> block.</p></li> <li><p><a href="https://polkadot.js.org/docs/api/start/api.query.multi/#multi-queries-same-type" target="_blank" rel="noopener noreferrer">api.query.module.method.multi()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> will multi queries of the <strong>same</strong> types at the current block.</p></li> <li><p><a href="https://polkadot.js.org/docs/api/start/api.query.multi/#multi-queries-distinct-types" target="_blank" rel="noopener noreferrer">api.queryMulti()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> will multi queries of the <strong>different</strong> types at the current block.</p></li></ul> <p>See an example of using the API in <a href="https://github.com/subquery/subql-examples/tree/main/validator-threshold" target="_blank" rel="noopener noreferrer">validator-threshold<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h3 id="examples"><a href="#examples" class="header-anchor">#</a> Examples</h3> <table><thead><tr><th>Example</th> <th>Description</th> <th>Keywords</th></tr></thead> <tbody><tr><td><a href="https://github.com/subquery/subql-examples/tree/main/extrinsic-finalized-block" target="_blank" rel="noopener noreferrer">extrinsic-finalized-block<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>Index extrinsics and so they can be queried by hash.</td> <td>blockHandler</td></tr> <tr><td><a href="https://github.com/subquery/subql-examples/tree/main/block-timestamp" target="_blank" rel="noopener noreferrer">block-timestamp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>Indexes timestamp of each finalized block.</td> <td>callHandler</td></tr> <tr><td><a href="https://github.com/subquery/subql-examples/tree/main/sum-reward" target="_blank" rel="noopener noreferrer">sum-reward<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>Indexes staking bond, reward and slash from events of finalized block.</td> <td>eventHandler</td></tr> <tr><td><a href="https://github.com/subquery/subql-examples/tree/main/kitty" target="_blank" rel="noopener noreferrer">kitty<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>Indexes birthinfo of kitties.</td> <td>callHandler, eventHandler, customTypes</td></tr> <tr><td><a href="https://github.com/subquery/subql-examples/tree/main/validator-threshold" target="_blank" rel="noopener noreferrer">validator-threshold<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>Indexes the least staking amount required for a validator to be elected.</td> <td>blockHandler, @polkadot/api</td></tr> <tr><td><a href="https://github.com/subquery/subql-examples/tree/main/entity-relation" target="_blank" rel="noopener noreferrer">entity-relation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>Indexes balance transfers between accounts, also indexes utility batchAll to find out the content of the extrinsic calls</td> <td>One-to-many, many-to-many relationship</td></tr></tbody></table> <h2 id="code-generation"><a href="#code-generation" class="header-anchor">#</a> Code Generation</h2> <div class="language- extra-class"><pre class="language-text"><code>yarn codegen
</code></pre></div><ul><li><p>This will create a new directory <code>src/types</code> which contains all generated entities in typescript.</p></li> <li><p>Generated entity class for each type you have defined previously in <code>schema.graphql</code>. These classes provide type-safe
entity loading, read and write access to entity fields.</p></li></ul> <h2 id="build"><a href="#build" class="header-anchor">#</a> Build</h2> <div class="language- extra-class"><pre class="language-text"><code>yarn build
</code></pre></div><p>Run build command will compile the project.</p> <h2 id="pack"><a href="#pack" class="header-anchor">#</a> Pack</h2> <div class="language- extra-class"><pre class="language-text"><code>yarn pack
</code></pre></div><p>Run pack command will compile and pack the project.</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/17/2021, 11:32:36 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/directory_structure.html" class="prev">
        Directory Structure
      </a></span> <span class="next"><a href="/indexing_query.html">
        Indexing and Query
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.eb975856.js" defer></script><script src="/assets/js/3.31cd00bf.js" defer></script><script src="/assets/js/9.de33af47.js" defer></script>
  </body>
</html>
